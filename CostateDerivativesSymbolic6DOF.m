function [lambdaDot, E_p, E_r, E_t] = CostateDerivativesSymbolic6DOF(t,X,dynamics,delta,Phi,eta,etaPrime,constraint)
    I1_1 = dynamics.inertia(1,1); I1_2 = dynamics.inertia(1,2); I1_3 = dynamics.inertia(1,3);
    I2_1 = dynamics.inertia(2,1); I2_2 = dynamics.inertia(2,2); I2_3 = dynamics.inertia(2,3);
    I3_1 = dynamics.inertia(3,1); I3_2 = dynamics.inertia(3,2); I3_3 = dynamics.inertia(3,3);
    Iinv1_1 = dynamics.inertiaInverse(1,1); Iinv1_2 = dynamics.inertiaInverse(1,2); Iinv1_3 = dynamics.inertiaInverse(1,3);
    Iinv2_1 = dynamics.inertiaInverse(2,1); Iinv2_2 = dynamics.inertiaInverse(2,2); Iinv2_3 = dynamics.inertiaInverse(2,3);
    Iinv3_1 = dynamics.inertiaInverse(3,1); Iinv3_2 = dynamics.inertiaInverse(3,2); Iinv3_3 = dynamics.inertiaInverse(3,3);
    r1 = X(1); r2 = X(2); r3 = X(3); 
    m = X(7); 
    p1 = X(8); p2 = X(9); p3 = X(10);
    w1 = X(11); w2 = X(12);w3 = X(13);
    lambda_r1 = X(14); lambda_r2 = X(15); lambda_r3 = X(16);
    lambda_v = X(17:19); 
    lambda_v1 = X(17); lambda_v2 = X(18); lambda_v3 = X(19);
    lambda_m = X(20); 
    lambda_p1 = X(21); lambda_p2 = X(22); lambda_p3 = X(23);
    lambda_w1 = X(24); lambda_w2 = X(25); lambda_w3 = X(26);

    W = dynamics.frameRotationRate;
    c = dynamics.exhaustVelocity;

    %% Efficiency improvements
    pNorm1 = p1^2 + p2^2 + p3^2 + 1;
    pNorm2 = pNorm1^2;
    pNorm13 = pNorm1^3;
    pNorm3 = 4*p1^2 + 4*p2^2 + 4*p3^2 - 4;
    C = cos(W*t);
    S = sin(W*t);

    %% Initialise Costate derivatives
    lambda_rDot =  [-3*W^2*lambda_v1
        0
        W^2*lambda_v3];
    
    lambda_vDot = [2*W*lambda_v2 - lambda_r1
        - lambda_r2 - 2*W*lambda_v1
                        -lambda_r3];

    lambda_mDot = 0;

    lambda_pDot = [
        lambda_p2*(w3/2 + (p1*w2)/2 - (p2*w1)/2) - lambda_p3*(w2/2 - (p1*w3)/2 + (p3*w1)/2) - lambda_p1*((p1*w1)/2 + (p2*w2)/2 + (p3*w3)/2)
        lambda_p3*(w1/2 + (p2*w3)/2 - (p3*w2)/2) - lambda_p1*(w3/2 + (p1*w2)/2 - (p2*w1)/2) - lambda_p2*((p1*w1)/2 + (p2*w2)/2 + (p3*w3)/2)
        lambda_p1*(w2/2 - (p1*w3)/2 + (p3*w1)/2) - lambda_p2*(w1/2 + (p2*w3)/2 - (p3*w2)/2) - lambda_p3*((p1*w1)/2 + (p2*w2)/2 + (p3*w3)/2)
        ];

    lambda_wDot = [
        lambda_p3*(p2/2 - (p1*p3)/2) - lambda_p2*(p3/2 + (p1*p2)/2) + lambda_w1*(Iinv1_1*(I2_1*w3 - I3_1*w2) - Iinv1_3*(2*I2_1*w1 - I1_1*w2 + I2_2*w2 + I2_3*w3) + Iinv1_2*(2*I3_1*w1 - I1_1*w3 + I3_2*w2 + I3_3*w3)) + lambda_w2*(Iinv2_1*(I2_1*w3 - I3_1*w2) - Iinv2_3*(2*I2_1*w1 - I1_1*w2 + I2_2*w2 + I2_3*w3) + Iinv2_2*(2*I3_1*w1 - I1_1*w3 + I3_2*w2 + I3_3*w3)) + lambda_w3*(Iinv3_1*(I2_1*w3 - I3_1*w2) - Iinv3_3*(2*I2_1*w1 - I1_1*w2 + I2_2*w2 + I2_3*w3) + Iinv3_2*(2*I3_1*w1 - I1_1*w3 + I3_2*w2 + I3_3*w3)) - lambda_p1*(p1^2/4 - p2^2/4 - p3^2/4 + 1/4)
        lambda_p1*(p3/2 - (p1*p2)/2) - lambda_p3*(p1/2 + (p2*p3)/2) - lambda_w1*(Iinv1_2*(I1_2*w3 - I3_2*w1) - Iinv1_3*(I1_1*w1 + 2*I1_2*w2 + I1_3*w3 - I2_2*w1) + Iinv1_1*(I3_1*w1 - I2_2*w3 + 2*I3_2*w2 + I3_3*w3)) - lambda_w2*(Iinv2_2*(I1_2*w3 - I3_2*w1) - Iinv2_3*(I1_1*w1 + 2*I1_2*w2 + I1_3*w3 - I2_2*w1) + Iinv2_1*(I3_1*w1 - I2_2*w3 + 2*I3_2*w2 + I3_3*w3)) - lambda_w3*(Iinv3_2*(I1_2*w3 - I3_2*w1) - Iinv3_3*(I1_1*w1 + 2*I1_2*w2 + I1_3*w3 - I2_2*w1) + Iinv3_1*(I3_1*w1 - I2_2*w3 + 2*I3_2*w2 + I3_3*w3)) + lambda_p2*(p1^2/4 - p2^2/4 + p3^2/4 - 1/4)
        lambda_p2*(p1/2 - (p2*p3)/2) - lambda_p1*(p2/2 + (p1*p3)/2) + lambda_w1*(Iinv1_3*(I1_3*w2 - I2_3*w1) - Iinv1_2*(I1_1*w1 + I1_2*w2 + 2*I1_3*w3 - I3_3*w1) + Iinv1_1*(I2_1*w1 + I2_2*w2 + 2*I2_3*w3 - I3_3*w2)) + lambda_w2*(Iinv2_3*(I1_3*w2 - I2_3*w1) - Iinv2_2*(I1_1*w1 + I1_2*w2 + 2*I1_3*w3 - I3_3*w1) + Iinv2_1*(I2_1*w1 + I2_2*w2 + 2*I2_3*w3 - I3_3*w2)) + lambda_w3*(Iinv3_3*(I1_3*w2 - I2_3*w1) - Iinv3_2*(I1_1*w1 + I1_2*w2 + 2*I1_3*w3 - I3_3*w1) + Iinv3_1*(I2_1*w1 + I2_2*w2 + 2*I2_3*w3 - I3_3*w2)) + lambda_p3*(p1^2/4 + p2^2/4 - p3^2/4 - 1/4)
        ];
    
    E_p = zeros(3,dynamics.numEngines); 
    E_r = zeros(3,dynamics.numEngines);
    E_t = zeros(dynamics.numEngines,1);
    for ii = 1:dynamics.numEngines
        u1 = dynamics.thrustDirectionBody(1,ii); u2 = dynamics.thrustDirectionBody(2,ii); u3 = dynamics.thrustDirectionBody(3,ii);
        T = dynamics.maxThrust(ii);
        if constraint.type ~= POINTING_CONSTRAINT_TYPE.NONE
            R = constraint.targetRadius;
            d1 = dynamics.engineLocationBody(1,ii); d2 = dynamics.engineLocationBody(2,ii); d3 = dynamics.engineLocationBody(3,ii);
            rB = Phi'*[r1;r2;r3]+dynamics.engineLocationBody(:,ii);

            etaCoeff = T*delta(ii)*((u3*(lambda_v1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + lambda_v2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - lambda_v3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(lambda_v3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - lambda_v1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + lambda_v2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) - u2*(lambda_v1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - lambda_v3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) + lambda_v2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2))))/m - lambda_m/c + (d2*u3 - d3*u2)*(Iinv1_1*lambda_w1 + Iinv2_1*lambda_w2 + Iinv3_1*lambda_w3) - (d1*u3 - d3*u1)*(Iinv1_2*lambda_w1 + Iinv2_2*lambda_w2 + Iinv3_2*lambda_w3) + (d1*u2 - d2*u1)*(Iinv1_3*lambda_w1 + Iinv2_3*lambda_w2 + Iinv3_3*lambda_w3));
 
            if rB'*dynamics.thrustDirectionBody(:,ii) >= 0
                E_p(:,ii) = [
                                                                                                                                      d3*(2*r1*(S*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13)) - 2*r3*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p2^2)/pNorm13) + 2*r2*(C*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13))) + 2*(u2*(r3*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + r1*(S*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) + C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + r2*(C*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) - S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13))) - u3*(r1*(S*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13)) - r3*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p2^2)/pNorm13) + r2*(C*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13))) + u1*(r1*(C*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13) + S*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13)) + r2*(C*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - S*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13)) + r3*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13)))*(u3*(d3 + r1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + r2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - r3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(d1 + r3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - r1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + r2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) + u2*(d2 + r3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - r1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - r2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)))) - d2*(2*r3*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + 2*r1*(S*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) + C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + 2*r2*(C*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) - S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13))) - d1*(2*r1*(C*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13) + S*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13)) + 2*r2*(C*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - S*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13)) + 2*r3*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13))
                                                                                                                                      2*(u3*(r3*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p1^2*p2)/pNorm13) + r1*(C*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13)) - r2*(S*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13))) - u1*(r3*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - r1*(C*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) + S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)) + r2*(S*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) - C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13))) + u2*(r1*(C*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + S*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13)) + r2*(C*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13) - S*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13)) + r3*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13)))*(u3*(d3 + r1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + r2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - r3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(d1 + r3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - r1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + r2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) + u2*(d2 + r3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - r1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - r2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)))) - d3*(2*r3*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p1^2*p2)/pNorm13) + 2*r1*(C*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13)) - 2*r2*(S*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13))) + d1*(2*r3*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - 2*r1*(C*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) + S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)) + 2*r2*(S*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) - C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13))) - d2*(2*r1*(C*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + S*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13)) + 2*r2*(C*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13) - S*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13)) + 2*r3*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13))
                    2*(u1*(r3*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + r1*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13)) + r2*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13))) + u2*(r3*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - r1*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13)) + r2*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13))) + u3*(r3*((32*p1^2*p3)/pNorm13 + (32*p2^2*p3)/pNorm13) + r1*(C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13) + S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + r2*(C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13) - S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13))))*(u3*(d3 + r1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + r2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - r3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(d1 + r3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - r1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + r2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) + u2*(d2 + r3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - r1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - r2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)))) - d2*(2*r3*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - 2*r1*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13)) + 2*r2*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13))) - d1*(2*r3*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + 2*r1*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13)) + 2*r2*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13))) - d3*(2*r3*((32*p1^2*p3)/pNorm13 + (32*p2^2*p3)/pNorm13) + 2*r1*(C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13) + S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + 2*r2*(C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13) - S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)))
                    ];

                
                E_r(:,ii) = [
                    d1*(2*C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - 2*S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) - d3*(2*C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + 2*S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) - 2*r1 + d2*(2*S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - 2*C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - 2*(u1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) - u3*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + u2*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)))*(u3*(d3 + r1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + r2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - r3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(d1 + r3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - r1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + r2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) + u2*(d2 + r3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - r1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - r2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2))))
                    d2*(2*C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + 2*S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - d3*(2*C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - 2*S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - d1*(2*S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + 2*C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) - 2*r2 + 2*(u3*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) + u1*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) - u2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)))*(u3*(d3 + r1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + r2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - r3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(d1 + r3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - r1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + r2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) + u2*(d2 + r3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - r1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - r2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2))))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2*(u1*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) + u2*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - u3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1))*(u3*(d3 + r1*(C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) + r2*(C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - r3*((8*p1^2)/pNorm2 + (8*p2^2)/pNorm2 - 1)) + u1*(d1 + r3*((8*p1*p3)/pNorm2 - (p2*(pNorm3))/pNorm2) - r1*(C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) + r2*(S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2))) + u2*(d2 + r3*((8*p2*p3)/pNorm2 + (p1*(pNorm3))/pNorm2) - r1*(S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - r2*(C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)))) - d1*((16*p1*p3)/pNorm2 - (2*p2*(pNorm3))/pNorm2) - d2*((16*p2*p3)/pNorm2 + (2*p1*(pNorm3))/pNorm2) - 2*r3 + d3*((16*p1^2)/pNorm2 + (16*p2^2)/pNorm2 - 2)
                     ];
                E_t(ii) = d1*(2*r1*(W*sin(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) + W*cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) - 2*r2*(W*sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - W*cos(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1))) - d2*(2*r1*(W*sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + W*cos(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1)) - 2*r2*(W*sin(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) - W*cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))) - d3*(2*r1*(W*sin(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - W*cos(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) + 2*r2*(W*sin(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + W*cos(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))) + 2*(u2*(r1*(W*sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + W*cos(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1)) - r2*(W*sin(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) - W*cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))) - u1*(r1*(W*sin(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) + W*cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) - r2*(W*sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - W*cos(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1))) + u3*(r1*(W*sin(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - W*cos(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) + r2*(W*sin(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + W*cos(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))))*(u3*(d3 + r1*(cos(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + sin(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) + r2*(cos(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - sin(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) - r3*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1)) + u1*(d1 + r3*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - r1*(cos(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) - sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) + r2*(sin(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) + cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))) + u2*(d2 + r3*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - r1*(sin(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) - cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) - r2*(cos(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) + sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))));
            else
                E_r(:,ii) = [
                    d1*(2*C*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - 2*S*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) - d3*(2*C*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2) + 2*S*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2)) - 2*r1 + d2*(2*S*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) - 2*C*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2))
                    d2*(2*C*((8*p1^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + 2*S*((8*p1*p2)/pNorm2 - (p3*(pNorm3))/pNorm2)) - d3*(2*C*((8*p2*p3)/pNorm2 - (p1*(pNorm3))/pNorm2) - 2*S*((8*p1*p3)/pNorm2 + (p2*(pNorm3))/pNorm2)) - d1*(2*S*((8*p2^2)/pNorm2 + (8*p3^2)/pNorm2 - 1) + 2*C*((8*p1*p2)/pNorm2 + (p3*(pNorm3))/pNorm2)) - 2*r2
                                                                                                                                                                                                                                                                                                                                                                                          d3*((16*p1^2)/pNorm2 + (16*p2^2)/pNorm2 - 2) - d1*((16*p1*p3)/pNorm2 - (2*p2*(pNorm3))/pNorm2) - d2*((16*p2*p3)/pNorm2 + (2*p1*(pNorm3))/pNorm2) - 2*r3
                     ];

                E_p(:,ii) = [
                                                                           d3*(2*r1*(S*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13)) - 2*r3*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p2^2)/pNorm13) + 2*r2*(C*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13))) - d2*(2*r3*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + 2*r1*(S*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) + C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + 2*r2*(C*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) - S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13))) - d1*(2*r1*(C*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13) + S*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13)) + 2*r2*(C*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - S*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13)) + 2*r3*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13))
                                                                               d1*(2*r3*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - 2*r1*(C*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) + S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)) + 2*r2*(S*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) - C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13))) - d3*(2*r3*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p1^2*p2)/pNorm13) + 2*r1*(C*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13)) - 2*r2*(S*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13))) - d2*(2*r1*(C*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + S*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13)) + 2*r2*(C*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13) - S*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13)) + 2*r3*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13))
                    - d2*(2*r3*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - 2*r1*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13)) + 2*r2*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13))) - d1*(2*r3*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + 2*r1*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13)) + 2*r2*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13))) - d3*(2*r3*((32*p1^2*p3)/pNorm13 + (32*p2^2*p3)/pNorm13) + 2*r1*(C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13) + S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + 2*r2*(C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13) - S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)))
                     ];
                E_t(ii) = d1*(2*r1*(W*sin(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) + W*cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) - 2*r2*(W*sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - W*cos(W*t)*((8*p2^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1))) - d2*(2*r1*(W*sin(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + W*cos(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1)) - 2*r2*(W*sin(W*t)*((8*p1^2)/(p1^2 + p2^2 + p3^2 + 1)^2 + (8*p3^2)/(p1^2 + p2^2 + p3^2 + 1)^2 - 1) - W*cos(W*t)*((8*p1*p2)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p3*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2))) - d3*(2*r1*(W*sin(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) - W*cos(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)) + 2*r2*(W*sin(W*t)*((8*p2*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 - (p1*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2) + W*cos(W*t)*((8*p1*p3)/(p1^2 + p2^2 + p3^2 + 1)^2 + (p2*(4*p1^2 + 4*p2^2 + 4*p3^2 - 4))/(p1^2 + p2^2 + p3^2 + 1)^2)));
            end

            lambda_rDot = lambda_rDot + etaCoeff*etaPrime(ii)/(R^2)*E_r(:,ii);
            lambda_pDot = lambda_pDot + etaCoeff*etaPrime(ii)/(R^2)*E_p(:,ii);
            if ~isreal(lambda_rDot)||any(isnan(lambda_rDot))|| any(lambda_rDot > 20)||lambda_mDot > 20
                tstop = ii;
            end
        end
        
        lambda_mDot = lambda_mDot + T/(m^2) * delta(ii)*eta(ii)*lambda_v'*Phi*dynamics.thrustDirectionBody(:,ii);

        lambda_pDot = lambda_pDot + T/m * delta(ii) *eta(ii)*[
            u3*(lambda_v1*(S*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13)) - lambda_v3*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p2^2)/pNorm13) + lambda_v2*(C*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13))) - u2*(lambda_v3*((8*p1^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p1^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + lambda_v1*(S*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) + C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + lambda_v2*(C*((32*p1^3)/pNorm13 - (16*p1)/pNorm2 + (32*p1*p3^2)/pNorm13) - S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13))) - u1*(lambda_v3*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p1^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13) + lambda_v1*(C*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13) + S*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13)) + lambda_v2*(C*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p1^2*p2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - S*((32*p1*p2^2)/pNorm13 + (32*p1*p3^2)/pNorm13)))
            u1*(lambda_v3*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - lambda_v1*(C*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) + S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)) + lambda_v2*(S*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p2*p3^2)/pNorm13) - C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13))) - u3*(lambda_v3*((32*p2^3)/pNorm13 - (16*p2)/pNorm2 + (32*p1^2*p2)/pNorm13) + lambda_v1*(C*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + S*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13)) - lambda_v2*(S*((8*p2^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p2^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - C*((8*p3)/pNorm2 - (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 + (4*p1*p2*(pNorm3))/pNorm13))) - u2*(lambda_v3*((8*p3)/pNorm2 + (8*p1*p2)/pNorm2 - (32*p2^2*p3)/pNorm13 - (4*p1*p2*(pNorm3))/pNorm13) + lambda_v1*(C*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + S*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13)) + lambda_v2*(C*((32*p1^2*p2)/pNorm13 + (32*p2*p3^2)/pNorm13) - S*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p2^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13)))
            - u1*(lambda_v3*((8*p1)/pNorm2 - (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 + (4*p2*p3*(pNorm3))/pNorm13) + lambda_v1*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13)) + lambda_v2*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 - (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p2^2*p3)/pNorm13))) - u2*(lambda_v3*((8*p2)/pNorm2 + (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 - (4*p1*p3*(pNorm3))/pNorm13) - lambda_v1*(C*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) - S*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13)) + lambda_v2*(S*((8*p3^2)/pNorm2 + (pNorm3)/pNorm2 - (4*p3^2*(pNorm3))/pNorm13 + (32*p1*p2*p3)/pNorm13) + C*((32*p3^3)/pNorm13 - (16*p3)/pNorm2 + (32*p1^2*p3)/pNorm13))) - u3*(lambda_v3*((32*p1^2*p3)/pNorm13 + (32*p2^2*p3)/pNorm13) + lambda_v1*(C*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13) + S*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13)) + lambda_v2*(C*((8*p2)/pNorm2 - (8*p1*p3)/pNorm2 - (32*p2*p3^2)/pNorm13 + (4*p1*p3*(pNorm3))/pNorm13) - S*((8*p1)/pNorm2 + (8*p2*p3)/pNorm2 - (32*p1*p3^2)/pNorm13 - (4*p2*p3*(pNorm3))/pNorm13)))
            ];

    end
    lambdaDot = [lambda_rDot;lambda_vDot;lambda_mDot;lambda_pDot;lambda_wDot];
    
    if ~isreal(lambdaDot)||any(isnan(lambdaDot)) 
        tstop = true;
    end
end